# PX4Ctrl
This repository is designed for PX4 control and it must be applied in conjunction with odometry algorithms, path planning and trajectory optimization algorithms.

## 1. Introduction
This PX4ctrl work mainly consists of two closely related parts: transform frame from vision to mavros and achieve PX4 control through PX4 commands.

### 1.1 **vision_to_mavros**
Since the fact that the odometry generated by SLAM algorithm is in *world* frame, it must be converted to the *map* frame before being sent to mavros. To this end, this package is designed to transform the frame of the odometry from *world* frame to *map* frame.

**Contribution 1:**
With the help of this package, the coresponding vision pose messages can be published to the mavros topic, "/mavros/vision_pose/pose", which provides vision pose to flight control unit. Later on, you can switch the flight mode to "altitude" mode or "position" mode to achieve altitude hold and position hold after setting the following parameters in QGroundControl.
```
EKF2_HGT_MODE = Vision
EKF2_AID_MASK = 24
```

**Contribution 2:**
transform the **odomtery** generated by SLAM algorithms (VINS-Fusion or MSCKF_VIO) and the **setpoint commands** (desired PVAQ of drone) generated by EGO-Swarm from *world* frame to *map* frame. Therefore, the FCU can control the drone move to the desired PVAQ in *map* frame correctly.

**Note!** Transforming the PVAQ from *world* frame to *map* frame is necessary when your imu (body) frame is not the same as the IMU of FCU, because the setpoint commands is generated from the odometry and setpoints in *world* frame but the motion of drone is relative to the FCU in *map* frame, and this difference can lead to fatal errors.


### 1.2 **px4cmd**
This PX4 command package is modified from [PX4ctrl](https://github.com/ZJU-FAST-Lab/Fast-Drone-250/tree/master/src/realflight_modules/px4ctrl), it designs a linear controller to estimate the thrust and altitude needed for drone to reach the desired PVAQ (Pose, Velocity, Acceleration, Quaternion) from current PVAQ.

**Note!** The desired and current PVAQ must be represented in *map* frame instead of *world*, especially when the *world* frame is not coincide with the *map* frame. Hense, this package must utilize the odometry and setpoint command converted by the vision_to_mavros package in this repository to correctly match the frame transformation relationship.

If you find this work useful or interesting, please kindly give us a star :star:, thanks!

## 2. Prerequisites
* System environment
  * [ROS Installation](http://wiki.ros.org/ROS/Installation)
  * [mavros](https://github.com/mavlink/mavros/blob/master/mavros/README.md#installation)
  * [librealsense](https://github.com/IntelRealSense/librealsense/tree/legacy) and [realsense-ros](https://github.com/IntelRealSense/realsense-ros/tree/ros1-legacy)
* Visual SLAM algorithms *(one is enough)*
  * [VINS-Fusion](https://github.com/HKUST-Aerial-Robotics/VINS-Fusion)
  * [VINS-Fusion-gpu](https://github.com/pjrambo/VINS-Fusion-gpu/tree/master)
  * [MSCKF-VIO](https://github.com/KumarRobotics/msckf_vio)
* Path planning and trajectory optimization algorithms
  * [EGO-Swarm](https://github.com/ZJU-FAST-Lab/ego-planner-swarm)


## 3. Build PX4Ctrl
Clone the repository and catkin_make:
```
cd ~/catkin_ws/src/PX4Ctrl/src
git clone https://github.com/xygxgn/px4ctrl.git
cd .. && catkin_make
source ~/catkin_ws/src/PX4ctrl/devel/setup.bash
```


## 4. Run PX4Ctrl
* **terminal 1:** run realsense d435i camera
  ```roslaunch realsense2_camera rs_d435i.launch```
* **terminal 2:** run mavros to connect with flight control unit
  * `roslaunch mavros px4_ACM.launch`
* **terminal 3:** run SLAM algorithm
  * If VINS-Fusion-gpu is used
    ```
    source ~/catkin_ws/src/vinsgpu/devel/setup.bash
    roslaunch vins realsense_d435i.launch
    ```
  * If MSCKF_VIO is used
    ```
    source ~/catkin_ws/src/msckf_vio/devel/setup.bash
    roslaunch vins msckf_vio_d435i.launch
    ```
* **terminal 4:** run path planning and trajectory optimization algorithm
  * `source ~/catkin_ws/src/egoswarm/devel/setup.bash`
  * `roslaunch ego_planner single_run_in_exp_d435i.launch`
* **terminal 5:** publish vision to mavros and broadercast the TF messages
  * `source ~/catkin_ws/src/px4ctrl/devel/setup.bash`
  * `roslaunch vision_to_mavros vision_to_mavros_d435i.launch`
* **terminal 6:** publish vision to mavros and broadercast the TF messages
  * `source ~/catkin_ws/src/px4ctrl/devel/setup.bash`
  * `roslaunch px4cmd px4cmd.launch`